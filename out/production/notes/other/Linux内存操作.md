# Linux内存操作

### 一，top命令（整机）

top命令是Linux下常用的性能分析工具，能够实时显示系统中各个进程的资源占用状况，类似于Windows的任务管理器。下面详细介绍它的使用方法。

top是一个动态显示过程,即可以通过用户按键来不断刷新当前状态.如果在前台执行该命令,它将独占前台,直到用户终止该程序为止。

比较准确的说,top命令提供了实时的对系统处理器的状态监视.它将显示系统中CPU最“敏感”的任务列表.

该命令可以按CPU使用.内存使用和执行时间对任务进行排序；而且该命令的很多特性都可以通过交互式命令或者在个人定制文件中进行设定.

#### 1，命令格式

​	`top [参数]`

#### 2，命令功能

显示当前系统正在执行的进程的相关信息，包括进程ID、内存占用率、CPU占用率等

#### 3，命令参数

~~~shell
top -b #批处理
top -c #显示完整的治命令
top -I #忽略失效过程
top -s #保密模式
top -S #累积模式
top -i<时间> #设置间隔时间
top -u<用户名> #指定用户名
top -p<进程号> #指定进程
top -n<次数> #循环显示的次数
~~~

#### 4，实例

~~~shell
# 前五行是当前系统情况整体的统计信息区
top - 15:18:28 up 14 days,  4:47,  1 user,  load average: 0.00, 0.03, 0.05
# 当前系统时间    系统已经持续运行时间   一个用户   load average后面是1,5,15min的负载情况
#load average数据是每隔5秒钟检查一次活跃的进程数，然后按特定算法计算出的数值。如果这个数除以逻辑CPU的数量，结果高于5的时候就表明系统在超负荷运转了
Tasks:  72 total,   1 running,  71 sleeping,   0 stopped,   0 zombie
#进程 系统的所有进程 72   一个正在执行   71个休眠         0个停止       0个僵尸进程
%Cpu(s):  0.7 us,  0.3 sy,  0.0 ni, 99.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
#cpu状态  用户空间，内核空间，改变过优先级的进程，空闲， IO等待， 硬中断，   软中断，    实时
KiB Mem :  1882072 total,   306824 free,   558664 used,  1016584 buff/cache
#内存状态   物理内存总量		使用中的内存总量    空闲内存总量       缓存的内存量
KiB Swap:        0 total,        0 free,        0 used.  1037148 avail Mem
#交换分区信息		交换区总量     空闲交换区总量   使用的交换区总量  缓冲的交换区总量
  PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND
#PID — 进程id
#USER — 进程所有者
#PR — 进程优先级
#NI — nice值。负值表示高优先级，正值表示低优先级
#VIRT — 进程使用的虚拟内存总量，单位kb。VIRT=SWAP+RES
#RES — 进程使用的、未被换出的物理内存大小，单位kb。RES=CODE+DATA
#SHR — 共享内存大小，单位kb
#S — 进程状态。D=不可中断的睡眠状态 R=运行 S=睡眠 T=跟踪/停止 Z=僵尸进程
#%CPU — 上次更新到现在的CPU时间占用百分比
#%MEM — 进程使用的物理内存百分比
#TIME+ — 进程使用的CPU时间总计，单位1/100秒
#COMMAND — 进程名称（命令名/命令行）
 1397 mysql     20   0 1400864 407384  13812 S  0.7 21.6 119:00.29 mysqld
  596 root      20   0  678672  21028   7656 S  0.3  1.1  39:57.17 exe
 9112 root      20   0  161888   2168   1548 R  0.3  0.1   0:00.02 top
    1 root      20   0   43540   3872   2612 S  0.0  0.2   1:46.86 systemd
    2 root      20   0       0      0      0 S  0.0  0.0   0:00.04 kthreadd
    4 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 kworker/0:0H
    6 root      20   0       0      0      0 S  0.0  0.0   0:34.41 ksoftirqd/0
    7 root      rt   0       0      0      0 S  0.0  0.0   0:00.00 migration/0
    8 root      20   0       0      0      0 S  0.0  0.0   0:00.00 rcu_bh
    9 root      20   0       0      0      0 S  0.0  0.0   1:14.91 rcu_sched
   10 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 lru-add-drain
   11 root      rt   0       0      0      0 S  0.0  0.0   0:07.12 watchdog/0
   13 root      20   0       0      0      0 S  0.0  0.0   0:00.00 kdevtmpfs
   14 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 netns
   15 root      20   0       0      0      0 S  0.0  0.0   0:00.42 khungtaskd
   16 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 writeback
   17 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 kintegrityd
   18 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 bioset
   19 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 bioset
   20 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 bioset
   21 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 kblockd
   22 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 md
   23 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 edac-poller
   24 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 watchdogd
   30 root      20   0       0      0      0 S  0.0  0.0   0:00.00 kswapd0
   31 root      25   5       0      0      0 S  0.0  0.0   0:00.00 ksmd
   32 root      39  19       0      0      0 S  0.0  0.0   0:03.03 khugepaged
   33 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 crypto
~~~

#### 4，其他使用

##### (1),多U多核CPU监控

在top基本视图中，按键盘数字“1”，可监控每个逻辑CPU的状况

##### (2),高亮显示当前运行进程

敲击键盘“b”（打开/关闭加亮效果）

##### (3),进程字段排序

敲击键盘“x”（打开/关闭排序列的加亮效果）

##### (4),通过”shift + >”或”shift + <”可以向右或左改变排序列

##### (5),显示完整命令

top -c

##### (6),以批处理模式显示程序信息

top -b

##### (7),以累积模式显示程序信息*

top -S

##### (8),设置信息更新次数

top -n 2  表示更新两次后终止更新显示

##### (9),设置信息更新时间

top -d 3  表示更新周期为3秒

##### (10),显示指定的进程信息

top -p 574

#### 5,top交互命令

在top 命令执行过程中可以使用的一些交互命令。这些命令都是单字母的，如果在命令行中使用了s 选项， 其中一些命令可能会被屏蔽。

~~~bash
h #显示帮助画面，给出一些简短的命令总结说明
k #终止一个进程。
i #忽略闲置和僵死进程。这是一个开关式命令。
q #退出程序
r #重新安排一个进程的优先级别
S #切换到累计模式
s #改变两次刷新之间的延迟时间(单位为s),如果有小数,就换算成ms。输入0值则系统将不断刷新,默认值是5 s
f或者F #从当前显示中添加或者删除项目
o或者O #改变显示项目的顺序
l #切换显示平均负载和启动时间信息
m #切换显示内存信息
t #切换显示进程和CPU状态信息
c #切换显示命令名称和完整命令行
M #根据驻留内存大小进行排序
P #根据CPU使用百分比大小进行排序
T #根据时间/累计时间进行排序
W #将当前设置写入~/.toprc文件中 
~~~

### 二，vmstat命令(CPU)

#### 1，vmstat说明

vmstat是Virtual Meomory Statistics（虚拟内存统计）的缩写，可对操作系统的虚拟内存、进程、CPU活动进行监控。他是对系统的整体情况进行统计，不足之处是无法对某个进程进行深入分析。vmstat 工具提供了一种低开销的系统性能观察方式。

该命令的功能是显示虚拟内存使用的情况

#### 2，命令格式

~~~shell
vmstat [-a] [-n] [-S unit] [delay [ count]]
vmstat [-s] [-n] [-S unit]
vmstat [-m] [-n] [delay [ count]]
vmstat [-d] [-n] [delay [ count]]
vmstat [-p disk partition] [-n] [delay [ count]]
vmstat [-f]
vmstat [-V]
~~~

~~~shell
#参数说明
-a：#显示活跃和非活跃内存
-f：#显示从系统启动至今的fork数量 。
-m：#显示slabinfo
-n：#只在开始时显示一次各字段名称。
-s：#显示内存相关统计信息及多种系统活动数量。
delay：#刷新时间间隔。如果不指定，只显示一条结果。
count：#刷新次数。如果不指定刷新次数,但指定了刷新时间间隔,这时刷新次数为无穷。
-d：#显示磁盘相关统计信息。
-p：#显示指定磁盘分区统计信息
-S：#使用指定单位显示。参数有 k 、K 、m 、M ，分别代表1000、1024、1000000、1048576字节（byte）。默认单位为K（1024 bytes）
-V：#显示vmstat版本信息。
~~~

#### 3，使用实例

##### vmstat   显示虚拟内存使用情况

~~~shell
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
#Procs（进程）：
#r: 运行队列中进程数量
#b: 等待IO的进程数量
##Memory（内存）：
#swpd: 使用虚拟内存大小
#free: 可用内存大小
#buff: 用作缓冲的内存大小
#cache: 用作缓存的内存大小
#Swap：
#si: 每秒从交换区写到内存的大小
#so: 每秒写入交换区的内存大小
#IO：（现在的Linux版本块的大小为1024bytes）
#bi: 每秒读取的块数
#bo: 每秒写入的块数
#系统：
#in: 每秒中断数，包括时钟中断。
#cs: 每秒上下文切换数。
#CPU:(以百分比表示)：
#us: 用户进程执行时间(user time)
#sy: 系统进程执行时间(system time)
#id: 空闲时间(包括IO等待时间),中央处理器的空闲时间 。以百分比表示。
#wa: 等待IO时间
#st: 实时
 7  0      0 305612 164280 854128    0    0     0     6   16   21  1  0 99  0  0
~~~

如果 r经常大于 4 ，且id经常少于40，表示cpu的负荷很重。如果pi，po 长期不等于0，表示内存不足。如果disk 经常不等于0， 且在 b中的队列 大于3， 表示 io性能不好。

##### vmstat -a  显示活跃和非活跃内存

~~~shell
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free  inact active   si   so    bi    bo   in   cs us sy id wa st
#Memory（内存）：
#inact: 非活跃内存大小（当使用-a选项时显示）
#active: 活跃的内存大小（当使用-a选项时显示
 2  0      0 305340 482940 922388    0    0     0     6   17   21  1  0 99  0  0

~~~

##### vmstat -f  查看系统已经fork了多少次

~~~shell
268959 forks
~~~

##### vmstat -s  查看内存使用的详细信息

##### vmstat -d  查看磁盘的读/写

##### vmstat -m  查看系统的slab信息

### 三，free命令(内存)

#### 1，命令说明

free命令可以显示Linux系统中空闲的、已用的物理内存及swap内存,及被内核使用的buffer。

free 命令显示系统使用和空闲的内存情况，包括物理内存、交互区内存(swap)和内核缓冲区内存。共享内存将被忽略

#### 2，命令格式

~~~shell
free [参数]
~~~

~~~shell
#参数说明
-b 　#以Byte为单位显示内存使用情况。 
-k 　#以KB为单位显示内存使用情况。 
-m 　#以MB为单位显示内存使用情况。
-g   #以GB为单位显示内存使用情况。 
-o 　#不显示缓冲区调节列。 
-s<间隔秒数> 　#持续观察内存使用状况。 
-t 　#显示内存总和列。 
-V 　#显示版本信息。
~~~

#### 3，使用实例

##### free  显示内存使用情况

~~~shell
              total        used        free      shared  buff/cache   available
#total:总计物理内存的大小。
#used:已使用多大。
#free:可用有多少。
#Shared:多个进程共享的内存总额。
#buff/cache:磁盘缓存的大小。
Mem:        1882072      558152      304952       98788     1018968     1037660
Swap:             0           0           0
~~~

>buffers和cached的区别呢

为了提高磁盘存取效率, Linux做了一些精心的设计, 除了对dentry进行缓存(用于VFS,加速文件路径名到inode的转换), 还采取了两种主要Cache方式：Buffer Cache和Page Cache。前者针对磁盘块的读写，后者针对文件inode的读写。这些Cache有效缩短了 I/O系统调用(比如read,write,getdents)的时间。

磁盘的操作有逻辑级（文件系统）和物理级（磁盘块），这两种Cache就是分别缓存逻辑和物理级数据的。

Page cache实际上是针对文件系统的，是文件的缓存，在文件层面上的数据会缓存到page cache。文件的逻辑层需要映射到实际的物理磁盘，这种映射关系由文件系统来完成。当page cache的数据需要刷新时，page cache中的数据交给buffer cache，因为Buffer Cache就是缓存磁盘块的。但是这种处理在2.6版本的内核之后就变的很简单了，没有真正意义上的cache操作。

Buffer cache是针对磁盘块的缓存，也就是在没有文件系统的情况下，直接对磁盘进行操作的数据会缓存到buffer cache中，例如，文件系统的元数据都会缓存到buffer cache中。

简单说来，page cache用来缓存文件数据，buffer cache用来缓存磁盘数据。在有文件系统的情况下，对文件操作，那么数据会缓存到page cache，如果直接采用dd等工具对磁盘进行读写，那么数据会缓存到buffer cache。

所以我们看linux,只要不用swap的交换空间,就不用担心自己的内存太少.如果常常swap用很多,可能你就要考虑加物理内存了.这也是linux看内存是否够用的标准.

##### free -t   以总和的形式显示内存的使用信息

##### free -s 10  周期性的查询内存使用信息

### 四，df命令(硬盘)

#### 1,命令说明

linux中df命令的功能是用来检查linux服务器的文件系统的磁盘空间占用情况。可以利用该命令来获取硬盘被占用了多少空间，目前还剩下多少空间等信息。

显示指定磁盘文件的可用空间。如果没有文件名被指定，则所有当前被挂载的文件系统的可用空间将被显示。

#### 2,命令格式

`df [选项] [文件]`

~~~shell
# 参数
-a #全部文件系统列表
-h #方便阅读方式显示
-H #等于“-h”，但是计算式，1K=1000，而不是1K=1024
-i #显示inode信息
-k #区块为1024字节
-l #只显示本地文件系统
-m #区块为1048576字节
--no-sync #忽略 sync 命令
-P #输出格式为POSIX
--sync #在取得磁盘信息前，先执行sync命令
-T #文件系统类型
#选择参数：
--block-size=<区块大小> #指定区块大小
-t<文件系统类型> #只显示选定文件系统的磁盘信息
-x<文件系统类型># 不显示选定文件系统的磁盘信息
--help #显示帮助信息
--version #显示版本信息
~~~

#### 3，实例

##### df   显示磁盘使用情况

##### df -i  以inode模式来显示磁盘使用情况

##### df -t ext3   显示指定类型磁盘

##### df -ia  列出各文件系统的i节点使用情况

##### df -T  列出文件系统的类型

##### df -h  以更易读的方式显示目前磁盘空间和使用情况 

~~~shell
#-h更具目前磁盘空间和使用情况 以更易读的方式显示
#-H根上面的-h参数相同,不过在根式化的时候,采用1000而不是1024进行容量转换
#-k以单位显示磁盘的使用情况
#-l显示本地的分区的磁盘空间使用率,如果服务器nfs了远程服务器的磁盘,那么在df上加上-l后系统显示的是过滤nsf驱动器后的结果
#-i显示inode的使用情况。linux采用了类似指针的方式管理磁盘空间影射.这也是一个比较关键应用#
~~~

### 五，iostat命令 (磁盘IO)

#### 1，命令说明

Linux系统中的 iostat是I/O statistics（输入/输出统计）的缩写，iostat工具将对系统的磁盘操作活动进行监视。它的特点是汇报磁盘活动统计情况，同时也会汇报出CPU使用情况。缺点是不能对某个进程进行深入分析，仅对系统的整体情况进行分析。

 通过iostat方便查看CPU、网卡、tty设备、磁盘、CD-ROM 等等设备的活动情况, 负载信息。

#### 2，命令格式

iostat[参数]\[时间\][次数]

~~~shell
#参数
-c #显示CPU使用情况
-d #显示磁盘使用情况
-k #以 KB 为单位显示
-m #以 M 为单位显示
-N #显示磁盘阵列(LVM) 信息
-n #显示NFS 使用情况
-p[磁盘] #显示磁盘和分区的情况
-t #显示终端和CPU的信息
-x #显示详细信息
-V #显示版本信息
~~~

#### 3,实例

##### iostat   显示所有设备负载情况

~~~shell
Linux 3.10.0-1062.9.1.el7.x86_64 (izuf653r015pxzev02q80ez) 	03/23/2020 	_x86_64_	(1 CPU)

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.62    0.00    0.46    0.08    0.00   98.83
#%user：CPU处在用户模式下的时间百分比。
#%nice：CPU处在带NICE值的用户模式下的时间百分比。
#%system：CPU处在系统模式下的时间百分比。
#%iowait：CPU等待输入输出完成时间的百分比。
#%steal：管理程序维护另一个虚拟处理器时，虚拟CPU的无意识等待时间百分比。
#%idle：CPU空闲时间百分比。
Device:            tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn
vda               0.75         0.33         5.78     411289    7187432
~~~

如果%iowait的值过高，表示硬盘存在I/O瓶颈，%idle值高，表示CPU较空闲，如果%idle值高但系统响应慢时，有可能是CPU等待分配内存，此时应加大内存容量。%idle值如果持续低于10，那么系统的CPU处理能力相对较低，表明系统中最需要解决的资源是CPU。

**disk属性值说明：**

~~~shell
#rrqm/s: 每秒进行 merge 的读操作数目。即 rmerge/s
#wrqm/s: 每秒进行 merge 的写操作数目。即 wmerge/s
#r/s: 每秒完成的读 I/O 设备次数。即 rio/s
#w/s: 每秒完成的写 I/O 设备次数。即 wio/s
#rsec/s: 每秒读扇区数。即 rsect/s
#wsec/s: 每秒写扇区数。即 wsect/s
#rkB/s: 每秒读K字节数。是 rsect/s 的一半，因为每扇区大小为512字节。
#wkB/s: 每秒写K字节数。是 wsect/s 的一半。
#avgrq-sz: 平均每次设备I/O操作的数据大小 (扇区)。
#avgqu-sz: 平均I/O队列长度。
#await: 平均每次设备I/O操作的等待时间 (毫秒)。
#svctm: 平均每次设备I/O操作的服务时间 (毫秒)。
#%util: 一秒中有百分之多少的时间用于 I/O 操作，即被io消耗的cpu百分比
~~~

##### iostat 2 3  定时显示所有信息   每隔 2秒刷新显示，且显示3次

##### iostat -d sda1   显示指定磁盘信息  

##### iostat -t  显示tty和Cpu信息

##### iostat -m  以M为单位显示所有信息

##### iostat -d -k 1 1   查看TPS和吞吐量信息

### 六，ifstat命令 (网络IO)




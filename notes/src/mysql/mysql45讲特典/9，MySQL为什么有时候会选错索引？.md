MySQL为什么有时候会选错索引？

- 优化器优化时会考虑的因素： 1.扫描行数 2.是否使用临时表 3. 是否需要排序
- 索引的“区分度”，建立索引的列的每一个值之间的区分程度越大，那就说明索引的区分度越好，一个索引上不同的值的个数，我们称之为“基数”
- mysql的到索引的基数是通过采样统计，采样统计的时候，InnoDB 默认会选择 N 个数据页，统计这些页面上的不同值，得到一个平均值，然后乘以这个索引的页面数，就得到了这个索引的基数。
- 而数据表是会持续更新的，索引统计信息也不会固定不变。所以，当变更的数据行数超过 1/M 的时候，会自动触发重新做一次索引统计。
- 通过设置参数 innodb_stats_persistent 的值来选择：
  - 设置为 on 的时候，表示统计信息会持久化存储。这时，默认的 N 是 20，M 是 10。
  - 设置为 off 的时候，表示统计信息只存储在内存中。这时，默认的 N 是 8，M 是 16。
- mysql选错索引的情况
  - 需要回表的时候（数据库根据索引（非主键）找到了指定的记录所在行后，还需要根据主键再次到数据块里获取数据的过程叫做回表），mysql的优化器会考虑这个成本
  - 优化器会优先选择排序字段所在索引，即使另一个索引的代价更小
  - 可以新建一个更合适的索引，来提供给优化器做选择，或删掉误用的索引。

